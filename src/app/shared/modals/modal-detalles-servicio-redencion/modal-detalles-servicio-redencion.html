<!-- © 2020 KIA COLOMBIA - CUSTOMER EXPERIENCE - TODOS LOS DERECHOS RESERVADOS -->
<app-loading-screen [messageInput]="'Cargando...'" [loading]="cargando"></app-loading-screen>
<div class="modal-header border-0 pb-0 animate__animated animate__fadeIn">
  <h4 class="modal-title fw-semibold text-dark">
    {{servicio.nombre}}
  </h4>
  <button
    type="button"
    class="btn-close"
    aria-label="Close"
    (click)="activeModal.dismiss('Cross click')"
  ></button>
</div>

<div class="modal-body animate__animated animate__fadeIn">
    <div class="row">
        <div class="col-md-12 mb-4">
              <div class="card-body">

                <hr>
                <div class="row">
                  <div class="col-6">
                    <h5>Frecuencia</h5>
                    <div class="small">
                      <strong>Kilometraje: </strong> {{ formatCurrency(servicio.frecuencia.kilometraje || 0) }} <br>
                      <strong>Meses: </strong> {{ servicio.frecuencia.meses }}
                    </div>
                  </div>

                  <div class="col-6">
                    <h5>Vigencia</h5>
                    <div class="small">
                      <strong>Kilometraje: </strong> {{ formatCurrency(servicio.vigencia.kilometraje || 0) }} <br>
                      <strong>Meses: </strong> {{ servicio.vigencia.meses }}
                    </div>
                  </div>
                </div>

                <hr>

                @if (evento === 'redimir') {
                <div>
                  <div class="d-flex justify-content-between mb-3">
                      <h5>Redención</h5>
                      <button
                        class="btn boton-secondary-kia"
                        (click)="redimirServicio()"
                      >
                        Redimir
                      </button>
                  </div>

                  <!-- ===================== NOMBRE ===================== -->
                  <div class="row mb-4">
                    <h6>Nombre</h6>
                    <div class="col-md-6">
                      <label class="form-label">Nombres</label>
                      <input type="text" class="form-control" [(ngModel)]="servicio.redencion.nombres.nombres">
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">Apellidos</label>
                      <input type="text" class="form-control" [(ngModel)]="servicio.redencion.nombres.apellidos">
                    </div>
                  </div>

                  <!-- ===================== IDENTIFICACIÓN ===================== -->
                  <div class="row mb-4">
                    <h6>Identificación</h6>

                    <div class="col-md-6">
                      <label class="form-label">Tipo de identificación</label>
                      <select class="form-select" [(ngModel)]="servicio.redencion.identificacion.tipo">
                        @for (item of tipoIdentificacionOpciones; track $index) {
                          <option [value]="item.value"> {{item.text}} </option>
                        }
                      </select>
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">Número</label>
                      <input type="text" class="form-control" [(ngModel)]="servicio.redencion.identificacion.numero">
                    </div>
                  </div>

                  <!-- ===================== CONCESIONARIO ===================== -->
                  <div class="row mb-4">
                    <h6>Concesionario</h6>

                    <div class="col-md-6">
                      <label class="form-label">Grupo</label>
                      <select class="form-select" (change)="toggleGrupo()" [(ngModel)]="grupoSeleccionado">
                        @for (item of listaGrupos; track $index) {
                          <option  [value]="item.value">{{ item.text }}</option>
                        }
                      </select>
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">Concesionario</label>
                      <select class="form-select" [(ngModel)]="servicio.redencion.concesionario.cl">
                        @for (item of concesionariosSeleccionados; track $index) {
                          <option [value]="item.value">{{ item.text }}</option>
                        }
                      </select>
                    </div>
                  </div>

                  <!-- ===================== OTROS DATOS ===================== -->
                  <div class="row mb-4">
                    <h6>Otros datos</h6>

                    <div class="col-md-6">
                      <label class="form-label">Link de la inspección</label>
                      <input type="text" class="form-control" [(ngModel)]="servicio.redencion.linkInspeccion">
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">Número Orden</label>
                      <input type="text" class="form-control" [(ngModel)]="servicio.redencion.numeroOrdenTrabajo">
                    </div>
                  </div>

                  <div class="row mb-4">

                    <div class="col-md-6">
                      <label class="form-label">Fecha Entrega Vehículo</label>
                      <input type="date" class="form-control" [(ngModel)]="servicio.redencion.fechaEntregaVehiculo">
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">Kilometraje</label>
                      <input type="text" class="form-control" [(ngModel)]="servicio.redencion.kilometrajeActual">
                    </div>

                  </div>

                  <!-- ===================== COMENTARIOS ===================== -->
                  <div class="row mb-4">
                    <div class="col-12">
                      <label class="form-label">Comentarios...</label>
                      <textarea class="form-control" rows="4" [(ngModel)]="servicio.redencion.comentarios"></textarea>
                    </div>
                  </div>

                </div>
                }

                @if (servicio.redencion.estatus) {
                  <!-- ===================== USUARIO QUE REDIME ===================== -->
                  <div class="row mb-4">
                    <h6>Usuario que redime</h6>
                    <div class="col-12">
                      <p class="m-0"><strong>Nombre:</strong> {{ servicio.redencion.usuarioQueRedime.nombreCompleto }}</p>
                      <p class="m-0"><strong>Identificación:</strong> {{ servicio.redencion.usuarioQueRedime.identificacion }}</p>
                      <p class="m-0"><strong>Correo electrónico:</strong> {{ servicio.redencion.usuarioQueRedime.email }}</p>
                    </div>
                  </div>
                }

                @if (evento === 'redimir') {
                <div class="row">
                  <div class="col-6">
                    <h6 class="text-muted">Prepagado</h6>
                    <div class="small">
                      <strong>Insumos: </strong> {{ servicio.precios.prepagado.insumos | currency:'$ ':'symbol':'0.0' }} <br>
                      <strong>Mano de obra: </strong> {{ servicio.precios.prepagado.manoObra | currency:'$ ':'symbol':'0.0' }} <br>
                      <strong>Repuestos: </strong> {{ servicio.precios.prepagado.repuestos | currency:'$ ':'symbol':'0.0' }} <br>
                      <strong>Comisión: </strong> {{ servicio.precios.prepagado.comision | currency:'$ ':'symbol':'0.0' }} <br>
                      <strong>IVA: </strong> {{ servicio.precios.prepagado.iva | currency:'$ ':'symbol':'0.0' }} <br>
                      <strong>Total: </strong> {{ servicio.precios.prepagado.total | currency:'$ ':'symbol':'0.0' }}
                    </div>
                  </div>
                </div>

                <hr>
                }

                <h5>Detalle operaciones</h5>

                @for (op of servicio.detalleOperaciones; track op._id; let opIdx = $index) {
                  <div class="p-2 border rounded mb-2 mt-3">

                    <strong>{{ op.nombre }}</strong>
                    <div class="small d-flex gap-3">
                      <span>Código: {{ op.codigo }}</span>
                      <span>Horas: {{ op.horas }}</span>
                    </div>

                    @if (op.repuestos.length > 0) {
                      <div class="table-responsive mt-3">
                        <table class="table table-striped table-bordered text-center align-middle mb-0">
                          <thead>
                            <tr>
                              <th rowspan="2">Referencia</th>
                              <th rowspan="2">PNC</th>
                              <th rowspan="2">Cantidad</th>
                              <th colspan="2">Margen</th>
                              <th colspan="2">Precio venta</th>
                            </tr>
                            <tr>
                              <th>Concesionario</th>
                              <th>Público</th>
                              <th>Concesionario</th>
                              <th>Público</th>
                            </tr>
                          </thead>
                          <tbody>
                            @for (item of op.repuestos; track item._id) {
                              <tr>
                                <td>{{ item.referencia }}</td>
                                <td>{{ item.pnc }}</td>
                                <td>{{ item.cantidad }}</td>
                                <td>{{ item.margen.precioVentaConcesionario }}</td>
                                <td>{{ item.margen.precioVentaPublico }}</td>
                                <td>$ {{ item.precioVenta.concesionario }}</td>
                                <td>$ {{ item.precioVenta.publico }}</td>
                              </tr>
                            } @empty {
                              <tr>
                                <td colspan="14" class="text-center py-4 text-muted">
                                  No hay repuestos registrados actualmente.
                                </td>
                              </tr>
                            }
                          </tbody>
                        </table>
                      </div>
                    }
                  </div>
                } @empty {
                  <div class="text-muted small">Sin operaciones registradas</div>
                }

              </div>
        </div>
    </div>
</div>

<div class="modal-footer border-0 pt-0 animate__animated animate__fadeIn">
  <button
    type="button"
    class="btn boton-principal-kia"
    (click)="activeModal.close()"
  >
    Cerrar
  </button>
</div>
