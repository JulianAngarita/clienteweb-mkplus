<app-loading-screen [messageInput]="'Cargando...'" [loading]="cargando"></app-loading-screen>
<div class="container-fluid p-5 mt-5" [formGroup]="paqueteForm">

  <div class="d-flex justify-content-end mb-3">
    <button class="btn btn-outline-dark d-flex align-items-center" (click)="onVolver()">
        Volver
    </button>
  </div>

  <h2 class="fw-bold mb-4">Edición de {{ paqueteForm.get('nombre')?.value }}</h2>

  <h5 class="fw-semibold mt-4 mb-3">Información Del Paquete</h5>

  <div class="row g-3">

    <div class="col-md-4">
      <label class="form-label">Nombre</label>
      <input class="form-control" formControlName="nombre" />
    </div>

    <div class="col-md-4">
      <label class="form-label">Descripción</label>
      <input class="form-control" formControlName="descripcion" />
    </div>

    <div class="col-md-4">
      <label class="form-label">Código</label>
      <input class="form-control" formControlName="codigoPaquete" />
    </div>

    <div class="col-md-3">
      <label class="form-label">Tipo</label>
      <select class="form-select" formControlName="tipoPaquete">
        @for (item of tipoPaqueteOpciones; track $index) {
          <option [value]="item.value">{{ item.text }}</option>
        }
      </select>
    </div>

  </div>

  <h5 class="fw-semibold mt-5 mb-3">Modelo Al Que Aplica</h5>

  <div class="row g-3" formGroupName="modelo">

    <div class="col-md-2">
      <label class="form-label">Código</label>
      <input class="form-control" formControlName="codigo" />
    </div>

    <div class="col-md-6">
      <label class="form-label">Descripción</label>
      <input class="form-control" formControlName="descripcion" />
    </div>

    <div class="col-md-4">
      <label class="form-label">Versión</label>
      <input class="form-control" formControlName="version" />
    </div>

  </div>


  <h5 class="fw-semibold mt-5 mb-3">Estado</h5>

  <div class="row g-3">

    <div class="col-md-4" formGroupName="estatus">
      <label class="form-label">Estado del Paquete</label>
      <select class="form-select" formControlName="nombre">
        @for (item of tipoEstadoSolicitudes; track $index) {
          <option [value]="item.value">{{ item.text }}</option>
        }
      </select>
    </div>

    <div class="col-md-4">
      <label class="form-label">Activación</label>
      <select class="form-select" formControlName="activo">
        @for (item of tipoPaqueteActivo; track $index) {
          <option [value]="item.value">{{ item.text }}</option>
        }
      </select>
    </div>

    <div class="col-md-4 d-flex align-items-center w-100 gap-3">
        <button
            class="btn boton-secondary-kia"
            (click)="anadirServicios()"
        >
            Añadir servicios
        </button>
        <button
            class="btn boton-principal-kia"
            (click)="actualizar()"
        >
            Actualizar
        </button>
    </div>

  </div>

  @if (servicios.length > 0) {
    <div class="table-responsive mt-5">
        <table class="table table-bordered align-middle text-center">
        
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Descripción</th>
                <th>Horas</th>
                <th>Código Modelo</th>

                <th>Aplica para</th>

                <th>Estatus</th>
                <th>Vigencia kilometraje</th>
                <th>Vigencia Meses</th>
                <th>Acciones</th>
            </tr>
        </thead>

        <tbody>
            @for (item of servicios; track $index) {
                <tr>

                    <td>{{ item.nombre }}</td>
                    <td>{{ item.descripcion }}</td>
                    <td>{{ item.cantidad }}</td>
                    <td>{{ item.modelo.codigo }}</td>
                    <td class="text-start">
                        <div class="d-flex flex-wrap gap-2">
                        @for (item of item.modelo.version || []; track $index) {
                            <span 
                                class="badge bg-secondary px-3 py-2"
                            >
                                {{ item }}
                            </span>
                        }    
                        </div>
                    </td>
                    <td class="text-start">
                        <div class="d-flex flex-wrap gap-2">
                        @for (item of item.consolidadoEstatus; track $index) {
                            <span 
                                class="badge bg-secondary px-3 py-2">
                                {{ item.nombre }}
                            </span>
                        }

                        </div>
                    </td>
                    <td>{{ item.vigencia.kilometraje }}</td>
                    <td>{{ item.vigencia.meses }}</td>
                    <td>
                        <div class="d-flex justify-content-center gap-2">
                            <button class="btn btn-sm btn-outline-danger" (click)="eliminar($index)">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </td>

                </tr>
            }
        </tbody>
        </table>
    </div>

    <div class="row">
        @for (i of servicios; track i._id) {

            <div class="col-md-6 mb-4">
            <div class="p-4 border rounded shadow-sm">

                <h1 class="h3 m-0">
                {{ i.nombre }}
                <div class="text-muted small mt-1">
                    {{ i.descripcion }}
                    <span class="badge bg-secondary ms-1">{{ i.tipo }}</span>
                </div>
                </h1>

                <hr>
                <div class="row">
                <div class="col-6">
                    <h5>Frecuencia</h5>
                    <div class="small">
                    <strong>Kilometraje: </strong> {{ formatCurrency(i.frecuencia.kilometraje || 0) }} <br>
                    <strong>Meses: </strong> {{ i.frecuencia.meses }}
                    </div>
                </div>

                <div class="col-6">
                    <h5>Vigencia</h5>
                    <div class="small">
                    <strong>Kilometraje: </strong> {{ formatCurrency(i.vigencia.kilometraje || 0) }} <br>
                    <strong>Meses: </strong> {{ i.vigencia.meses }}
                    </div>
                </div>
                </div>

                <hr>

                <div class="row">
                <div class="col-6">
                    <h5>Precio Repuestos</h5>
                    <div class="small">
                    <strong>Publico: </strong> {{ formatCurrency(i.preciosRepuestos.publico || 0) }} <br>
                    <strong>Concesionario: </strong> {{ formatCurrency(i.preciosRepuestos.concesionario || 0) }} <br>
                    <strong>Descuentos: </strong> {{ i.preciosRepuestos.descuento }}% <br>
                    <strong>Publico después de descuento: </strong> {{ formatCurrency(i.preciosRepuestos.publicoDespuesDescuento || 0) }} <br>
                    <strong>Concesionario después de descuento: </strong> {{ formatCurrency(i.preciosRepuestos.concesionarioDespuesDescuento || 0) }}
                    </div>
                </div>

                <div class="col-6">
                    <h5>Mano de Obra</h5>
                    <div class="small">
                    <strong>Horas: </strong> {{ i.preciosManoObra.horas }} <br>
                    <strong>Valor horas: </strong> {{ i.preciosManoObra.valorHoras }} <br>
                    <strong>Valor horas después de factor: </strong> {{ i.preciosManoObra.valorHorasDespuesFactor }}
                    </div>
                </div>
                </div>

                <hr>

                <h5>Detalle operaciones</h5>

                @for (op of i.detalleOperaciones; track op._id) {
                    <div class="p-2 border rounded mb-2 mt-3">
                        <div><strong>{{ op.nombre }}</strong></div>
                        <div class="small d-flex gap-3">
                            <span>Código: {{ op.codigo }}</span>
                            <span>Horas: {{ op.horas }}</span>
                        </div>

                        @if(op.repuestos && op.repuestos.length > 0) {
                            <div class="table-responsive mt-3">
                                <table class="table table-striped table-bordered text-center align-middle mb-0">

                                    <thead>
                                        <tr>
                                            <th rowspan="2">Referencia</th>
                                            <th rowspan="2">PNC</th>
                                            <th rowspan="2">Cantidad</th>

                                            <th colspan="2">Margen</th>

                                            <th colspan="2">Precio venta</th>
                                        </tr>

                                        <tr>
                                            <th>Concesionario</th>
                                            <th>Publico</th>

                                            <th>Concesionario</th>
                                            <th>Publico</th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        @for (item of op.repuestos; track item._id) {
                                        <tr>
                                            <td>{{ item.referencia }}</td>
                                            <td>{{ item.pnc }}</td>
                                            <td>{{ item.cantidad }}</td>

                                            <td>{{ item.margen.precioVentaConcesionario }}</td>
                                            <td>{{ item.margen.precioVentaPublico }}</td>

                                            <td>$ {{ item.precioVenta.concesionario }}</td>
                                            <td>$ {{ item.precioVenta.publico }}</td>
                                        </tr>
                                        } @empty {
                                        <tr>
                                            <td colspan="14" class="text-center py-4 text-muted">
                                                No hay repuestos registrados actualmente.
                                            </td>
                                        </tr>
                                        }
                                        
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                } @empty {
                    <div class="text-muted small">Sin operaciones registradas</div>
                }

            </div>
            </div>

        } @empty {
            <div class="text-center text-muted py-5">
            <strong>No hay elementos</strong>
            </div>
        }
        </div>

  }


</div>
