<app-loading-screen [messageInput]="'Cargando...'" [loading]="cargando"></app-loading-screen>
@if (consultaActiva) {
<div class="container align-items-center d-flex justify-content-center mt-5 py-5" style="min-height: 80vh;">
  <div class="col-12 col-md-6">

    <h2 class="fw-bold">Bienvenido,</h2>
    <h4 class="mb-4">Inicia una nueva solicitud</h4>


      <!-- Tipo de documento -->
      <div class="mb-3">
        <label class="form-label">Tipo de documento</label>
        <select class="input-kia-field" [(ngModel)]="filtroSolicitud.identificacion.tipo">
            @for (item of identificacionOpciones; track $index) {
                <option [value]="item.value"> {{item.text}} </option>
            }
        </select>
      </div>

      <!-- Número -->
      <div class="mb-3">
        <label class="form-label">Número</label>
        <input type="text" class="input-kia-field" placeholder="Número de Identidad" [(ngModel)]="filtroSolicitud.identificacion.numero">
      </div>

      <!-- Concesionario -->
      <div class="mb-4">
        <label class="form-label">Concesionario (CL)</label>
        <input type="text" class="input-kia-field" placeholder="" [(ngModel)]="filtroSolicitud.concesionario">
      </div>

      <!-- Botón -->
      <button class="btn boton-principal-kia px-4" type="button" (click)="buscarSolicitud()">
        Buscar
      </button>

  </div>
</div>
}

@if (!consultaActiva) {
<div class="container mt-5 py-5">

  <h2 class="fw-bold">Solicitud</h2>
  <p class="mb-0"><strong>Código de la solicitud:</strong> #{{datosSolicitud.solicitud.numero}}</p>
  <p> <strong>Estado:</strong> {{datosSolicitud.estado}}</p>
  <div class="col-md-6 my-5">
    <div class="d-flex gap-3">
      <a (click)="verAcuerdo()">Acuerdo de servicios prepagados</a>
      <a (click)="enviarAcuerdoWhatsapp()">Enviar acuerdo Whatsapp</a>
    </div>
  </div>
  <!-- Navegación -->
  <ul ngbNav #nav="ngbNav" class="nav nav-tabs mb-3">
    <!-- Datos solicitud -->
    <li [ngbNavItem]="1">
      <a ngbNavLink>Solicitud</a>
      <ng-template ngbNavContent>

        <!-- CARD: Datos del Cliente -->
        <div class="card p-4 shadow-sm mb-4">
          <h5 class="fw-bold">Datos del Cliente</h5>
          <div class="row mt-3">
            <div class="col-md-6">
              <p><strong>Nombre:</strong> {{datosCliente.nombre.nombres}} {{datosCliente.nombre.apellidos}}</p>
              <p><strong>Email:</strong> {{datosCliente.email}}</p>
              <p><strong>Fijo:</strong> {{datosCliente.telefonos.fijo}}</p>
              <p><strong>Tipo de Documento:</strong> {{datosCliente.identificacion.tipo}} </p>
            </div>

            <div class="col-md-6">
              <p><strong>Dirección:</strong> 
                  {{datosCliente.direccion.callePrincipal}}
                  {{datosCliente.direccion.calleSecundaria}} 
                  {{datosCliente.direccion.numero}}
                  {{datosCliente.direccion.departamento}}
                  {{datosCliente.direccion.ciudad}}
              </p>
              <p><strong>Celular:</strong> {{datosCliente.telefonos.celular}}</p>
              <p><strong>Otros:</strong> {{datosCliente.telefonos.otros}} </p>
              <p><strong>Número de Documento:</strong> {{datosCliente.identificacion.numero}}</p>
            </div>
          </div>
          <div class="col-md-6">
            <button class="btn boton-secondary-kia mt-2" (click)="editarCliente()">Editar cliente</button>
          </div>
        </div>

        <!-- CARD: Vehículo -->
        <div class="card p-4 shadow-sm mb-4">
          <h5 class="fw-bold">Vehículo</h5>
          @if (datosVehiculo._id) {
            <div class="row mt-3">
              <div class="col-md-6">
                <p> <strong>Placa:</strong> {{datosVehiculo.placa}} </p>
                <p> <strong>Versión:</strong> {{datosVehiculo.version}} </p>
                <p> <strong>Código modelo:</strong> {{datosVehiculo.modelo.codigo}} </p>
                <p> <strong>Año del modelo:</strong> {{datosVehiculo.modelo.anoModelo}} </p>
              </div>
              <div class="col-md-6">
                <p> <strong>VIN:</strong> {{datosVehiculo.vin}} </p>
                <p> <strong>Descripción:</strong> {{datosVehiculo.descripcionVersion}} </p>
                <p> <strong>Nombre:</strong> {{datosVehiculo.modelo.nombre}} </p>
                <p> <strong>Origen:</strong> {{datosVehiculo.modelo.origen}} </p>
              </div>
              <div class="col-md-6">
                <button class="btn boton-secondary-kia mt-2" (click)="editarVehiculo()">Editar vehículo</button>
              </div>
              <div class="col-md-3">
                <div class="input-group mt-3 mx-auto" style="max-width: 400px;">
                  <input type="text" class="form-control" placeholder="VIN" [(ngModel)]="VINBusqueda">
                  <button class="btn btn-outline-dark" (click)="consultaVehiculo()">
                    <i class="fa fa-search"></i>
                  </button>
                </div>
              </div>
            </div>
          } @else {
            <div class="text-center p-5">
              <p class="mb-1">Aún no se ha agregado un vehículo a la solicitud.</p>
              <p>Para agregarlo escribe el VIN en el campo y clic sobre buscar.</p>
              <button 
                class="btn boton-secondary-kia mt-2"
                (click)="anadirVehiculo()"
              >
                Agregar vehículo manualmente
              </button>
              <div class="input-group mt-3 mx-auto" style="max-width: 400px;">
                <input type="text" class="form-control" placeholder="VIN" [(ngModel)]="VINBusqueda">
                <button class="btn btn-outline-dark" (click)="consultaVehiculo()">
                  <i class="fa fa-search"></i>
                </button>
              </div>
            </div>
          }
        </div>

        <!-- Datos de la Solicitud -->
        <div class="card p-4 shadow-sm mb-4">
          <h5 class="fw-bold">Datos de la Solicitud</h5>

          <div class="row mt-3">
            <div class="col-md-3">
              <p><strong>Grupo:</strong> {{datosSolicitud.concesionario.grupo}}</p>
            </div>
            <div class="col-md-3">
              <p><strong>Código CL:</strong> {{datosSolicitud.concesionario.cl}}</p>
            </div>
            <div class="col-md-3">
              <p><strong>Concesionario:</strong> {{datosSolicitud.concesionario.nombre}}</p>
            </div>
            <div class="col-md-3">
              <p><strong>Fecha Creación:</strong> {{datosSolicitud.creado | date: 'dd-MM-yyyy hh:mm a'}}</p>
            </div>
            <div class="col-md-6">
              <p><strong>Ultima actualización:</strong> {{datosSolicitud.actualizado | date: 'dd-MM-yyyy hh:mm a'}}</p>
            </div>
          </div>

          <p class="mt-3 text-muted">IVA {{datosSolicitud.valor.iva | currency:'$ ':'symbol':'0.0'}}</p>
          <h4 class="fw-bold">Valor Total: {{datosSolicitud.valor.valorTotal | currency:'$ ':'symbol':'0.0'}}</h4>

          <div class="mt-3">
            <button class="btn boton-secondary-kia me-2">Agregar paquete</button>
            <button class="btn boton-principal-kia">Guardar cambios</button>
          </div>
        </div>

      </ng-template>
    </li>
    <!-- paquetes -->
    <li [ngbNavItem]="2">
      <a ngbNavLink>Paquetes</a>
      <ng-template ngbNavContent>
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2>Paquetes</h2>
          <button class="btn boton-secondary-kia" (click)="agregarPaquetesSolicitud()">
            Agregar paquete
          </button>
        </div>
        @if (datosPaquetes.length > 0) {
          <div class="table-responsive">
            <table class="table table-bordered align-middle">
              <thead class="table-light">
                <tr class="text-center">
                  <th>Nombre</th>
                  <th>Descripción</th>
                  <th>Código de paquete</th>
                  <th>Tipo de paquete</th>
                  <th>Estatus Int.</th>
                  <th>Código modelo</th>
                  <th>Versión modelo</th>
                  <th>Descripción modelo</th>
                  <th class="text-center">Detalles</th>
                </tr>
              </thead>

              <tbody>
                @for (item of datosPaquetes; track $index) {
                  <tr class="text-center text-sm">
                    <td>{{ item.nombre }}</td>
                    <td>{{ item.descripcion }}</td>
                    <td>{{ item.codigoPaquete }}</td>
                    <td>{{ item.tipoPaquete }}</td>
                    <td>{{ item.activo ? 'Activo' : 'Inactivo' }}</td>
                    <td>{{ item.modelo.codigo }}</td>
                    <td>{{ item.modelo.version }}</td>
                    <td>{{ item.modelo.descripcion }}</td>

                    <td class="text-center">
                      <div class="d-flex">
                        <button class="btn btn-light me-2" (click)="verDetallePaquete(item)">
                          <i class="fa fa-eye"></i>
                        </button>
                        <button class="btn btn-light" (click)="eliminarPaqueteSolicitud(item)">
                          <i class="fa fa-trash"></i>
                        </button>
                      </div>
                    </td>

                  </tr>
                }
              </tbody>
            </table>
          </div>
        } @else {
          <div class="card shadow-sm p-4 text-center">
            <h4 class="mb-2">No hay paquetes agregados</h4>
            <p class="text-muted mb-4">
              Aún no has añadido ningún paquete a la solicitud.
            </p>
            <div class="col-md-6 align-self-center">
              <button class="btn boton-secondary-kia" (click)="agregarPaquetesSolicitud()">
                Agregar paquete
              </button>
            </div>
          </div>
        }
      </ng-template>
    </li>
    <!-- soportes -->
    <li [ngbNavItem]="3">
      <a ngbNavLink>Soportes</a>
      <ng-template ngbNavContent>
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2>Soportes</h2>
          <button class="btn boton-secondary-kia" (click)="agregarSoporteSolicitud()">
            Agregar soporte
          </button>
        </div>
          @if (datosSolicitud.soportes.length > 0) {
            <div class="table-responsive">
              <table class="table table-bordered align-middle">
                <thead class="table-light">
                  <tr class="text-center">
                    <th>Nombre</th>
                    <th>Tipo</th>
                    <th>Comentarios</th>
                    <th>Fecha de carga</th>
                    <th>Revisado</th>
                    <th>Ver soporte</th>
                  </tr>
                </thead>
                <tbody>
                  @for (item of datosSolicitud.soportes; track $index) {
                    <tr class="text-center text-sm">
                      <td>{{item.nombre}}</td>
                      <td>{{item.tipo}}</td>
                      <td>{{item.comentarios}}</td>
                      <td>{{item.fechaCarga | date: 'dd-mm-yyyy hh:mm a'}}</td>
                      <td class="text-center">
                        <div class="form-check form-switch align-items-center">
                          <input
                              class="form-check-input"
                              type="checkbox"
                              role="switch"
                              [checked]="item.revisado"
                              (click)="revisarSoporte($index)"
                          />
                        </div>
                      </td>
                      <td class="text-center">
                        <button class="btn btn-light me-2" (click)="verSoporte(item)">
                          <i class="fa fa-eye"></i>
                        </button>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          } @else {
            <div class="card shadow-sm p-4 text-center">
              <h4 class="mb-2">Esta solicitud no tiene ningún soporte</h4>
              <p class="text-muted mb-4">
                Aún no has añadido ningún soporte a la solicitud.
              </p>
              <div class="col-md-6 align-self-center">
                <button class="btn boton-secondary-kia" (click)="agregarSoporteSolicitud()">
                  Agregar soporte
                </button>
              </div>
            </div>
          }
      </ng-template>
    </li>
    <!-- activacion -->
    <li [ngbNavItem]="4">
      <a ngbNavLink>Activación</a>
      <ng-template ngbNavContent>
         <div class="d-flex justify-content-center align-items-center mb-3">
          <h2>Paquetes a Activar</h2>
        </div>
        @for (item of datosPaquetes; track $index) {
          <div class="d-flex justify-content-between my-1">
            <div>
                <h3> {{item.nombre}} </h3>
                <h4 class="text-muted"> {{item.descripcion}} </h4>
            </div>
            <button
              class="btn boton-secondary-kia"
              (click)="activarPaquete(item)"
            >
              Activar
            </button>
          </div>

        }
      </ng-template>
    </li>
    <!-- redencion -->
    <li [ngbNavItem]="5">
      <a ngbNavLink>Redención</a>
      <ng-template ngbNavContent>
        <div class="d-flex justify-content-start align-items-center mb-3">
          <h2>Servicios a redimir</h2>
        </div>
        <div class="table-responsive">
          <table class="table table-bordered align-middle">
            <thead class="table-light text-center">
              <tr>
                <th rowspan="2">Nombre</th>
                <th rowspan="2">Descripción</th>
                <th rowspan="2">Tipo</th>
                <th rowspan="2">Cantidad</th>
                <th rowspan="2">Mano obra unificada</th>
                <th colspan="2">Frecuencia</th>
                <th colspan="3">Vigencia</th>
                <th colspan="2">Redencion</th>
                <th rowspan="2">Acciones</th>
              </tr>
              <tr>
                <th>Kilometraje</th>
                <th>Meses</th>
                <th>Autorizado</th>
                <th>Kilometraje</th>
                <th>Meses</th>
                <th>Estado</th>
                <th>Fecha</th>
              </tr>
            </thead>
            <tbody>
              @for (paquete of datosPaquetes; track $index) {
                @for (servicio of paquete.detallesServicios; track $index) {
                  <tr class="text-center">
                    <td> {{servicio.nombre}} </td>
                    <td> {{servicio.descripcion}} </td>
                    <td> {{servicio.tipo}} </td>
                    <td> {{servicio.cantidad}} </td>
                    <td> {{servicio.tarifaManoObraUnificada ? 'Unificada' : 'No unificada'}} </td>
                    <td> {{servicio.frecuencia.kilometraje}} </td>
                    <td> {{servicio.frecuencia.meses}} </td>
                    <td>
                      <span 
                        class="badge"
                        [class.bg-success]="servicio.vigencia.autorizadoPorImportadora"
                        [class.bg-danger]="!servicio.vigencia.autorizadoPorImportadora"
                        style="cursor: pointer;"
                      >
                        {{ servicio.vigencia.autorizadoPorImportadora ? 'Autorizado' : 'No autorizado' }}
                      </span>
                    </td>
                    <td> {{servicio.vigencia.kilometraje}} </td>
                    <td> {{servicio.vigencia.meses}} </td>
                    <td> {{servicio.redencion.estatus ? 'Redimido' : 'Pendiente'}} </td>
                    <td> {{servicio.redencion.fechaRedencion | date: 'dd-MM-yyyy hh:mm a'}} </td>
                    <td class="text-center">
                      <button
                        class="btn btn-outline-dark"
                        (click)="verServicioRedencion(servicio)"
                      >
                        Ver
                      </button>
                    </td>
                  </tr>
                }
              }
            </tbody>
          </table>
        </div>
      </ng-template></li>
  </ul>

  <div [ngbNavOutlet]="nav"></div>

</div>
}


